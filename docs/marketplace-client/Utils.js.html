

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="images/favicon.png" >

  <title>
    Utils.js - Documentation
  </title>

  <script src="scripts/prettify/prettify.js"></script>
  <script src="scripts/prettify/lang-css.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/elv-jsdoc.css">
  <link type="text/css" rel="stylesheet" href="styles/elv-prettify-jsdoc.css">
</head>

<body>
  <div class="layout-container">
    <nav class="nav-container">
      <div class="header">
        <a href="index.html">
          <img class="logo" src="images/logo-dark.png" />
        </a>
        <div class="title">
          Eluvio Marketplace Client
        </div>
      </div>
      <div class="nav-content">
        <h3>Classes</h3><ul><li id="ElvMarketplaceClient-nav">
          <div data-name="ElvMarketplaceClient" class="class-link-container"><a class="class-link">ElvMarketplaceClient</a></div><ul class='methods'><h4 class="methodGroupHeader">Constructor</h4><li data-type="method" id="ElvMarketplaceClient-ElvMarketplaceClient-nav"><a href="ElvMarketplaceClient.html" class="method-link">ElvMarketplaceClient</a></li><h4 class="methodGroupHeader">Authorization</h4><li data-type="method" id="ElvMarketplaceClient-Authenticate-nav"><a href="ElvMarketplaceClient.html#Authenticate" class="method-link">Authenticate</a></li><li data-type="method" id="ElvMarketplaceClient-AuthenticateExternalWallet-nav"><a href="ElvMarketplaceClient.html#AuthenticateExternalWallet" class="method-link">AuthenticateExternalWallet</a></li><li data-type="method" id="ElvMarketplaceClient-AuthenticateOAuth-nav"><a href="ElvMarketplaceClient.html#AuthenticateOAuth" class="method-link">AuthenticateOAuth</a></li><h4 class="methodGroupHeader">Initialization</h4><li data-type="method" id="ElvMarketplaceClient-Initialize-nav"><a href="ElvMarketplaceClient.html#.Initialize" class="method-link">Initialize</a></li><h4 class="methodGroupHeader">Login</h4><li data-type="method" id="ElvMarketplaceClient-LogIn-nav"><a href="ElvMarketplaceClient.html#LogIn" class="method-link">LogIn</a></li><li data-type="method" id="ElvMarketplaceClient-LogOut-nav"><a href="ElvMarketplaceClient.html#LogOut" class="method-link">LogOut</a></li></ul></li></ul><h3>Modules</h3><ul><li id="ElvMarketplaceClient_ClientMethods-nav">
          <div data-name="ElvMarketplaceClient/ClientMethods" class="class-link-container"><a class="class-link">ElvMarketplaceClient/ClientMethods</a></div><ul class='methods'><li data-type="method" id="ElvMarketplaceClient_ClientMethods-ElvMarketplaceClient/ClientMethods-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html" class="method-link">ElvMarketplaceClient/ClientMethods</a></li><h4 class="methodGroupHeader">Items</h4><li data-type="method" id="ElvMarketplaceClient_ClientMethods-NFT-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.NFT" class="method-link">NFT</a></li><h4 class="methodGroupHeader">Listings</h4><li data-type="method" id="ElvMarketplaceClient_ClientMethods-CreateListing-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.CreateListing" class="method-link">CreateListing</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-Listing-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.Listing" class="method-link">Listing</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-ListingAttributes-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.ListingAttributes" class="method-link">ListingAttributes</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-ListingEditionNames-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.ListingEditionNames" class="method-link">ListingEditionNames</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-ListingNames-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.ListingNames" class="method-link">ListingNames</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-Listings-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.Listings" class="method-link">Listings</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-ListingStats-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.ListingStats" class="method-link">ListingStats</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-ListingStatus-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.ListingStatus" class="method-link">ListingStatus</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-RemoveListing-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.RemoveListing" class="method-link">RemoveListing</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-Sales-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.Sales" class="method-link">Sales</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-SalesStats-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.SalesStats" class="method-link">SalesStats</a></li><h4 class="methodGroupHeader">Marketplaces</h4><li data-type="method" id="ElvMarketplaceClient_ClientMethods-AvailableMarketplaces-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.AvailableMarketplaces" class="method-link">AvailableMarketplaces</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-Marketplace-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.Marketplace" class="method-link">Marketplace</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-MarketplaceCSS-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.MarketplaceCSS" class="method-link">MarketplaceCSS</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-MarketplaceInfo-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.MarketplaceInfo" class="method-link">MarketplaceInfo</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-MarketplaceStock-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.MarketplaceStock" class="method-link">MarketplaceStock</a></li><h4 class="methodGroupHeader">Tenants</h4><li data-type="method" id="ElvMarketplaceClient_ClientMethods-TenantConfiguration-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.TenantConfiguration" class="method-link">TenantConfiguration</a></li><h4 class="methodGroupHeader">User</h4><li data-type="method" id="ElvMarketplaceClient_ClientMethods-UserAddress-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.UserAddress" class="method-link">UserAddress</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-UserInfo-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.UserInfo" class="method-link">UserInfo</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-UserItemInfo-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.UserItemInfo" class="method-link">UserItemInfo</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-UserItems-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.UserItems" class="method-link">UserItems</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-UserListings-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.UserListings" class="method-link">UserListings</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-UserSales-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.UserSales" class="method-link">UserSales</a></li><li data-type="method" id="ElvMarketplaceClient_ClientMethods-UserWalletBalance-nav"><a href="module-ElvMarketplaceClient_ClientMethods.html#.UserWalletBalance" class="method-link">UserWalletBalance</a></li></ul></li></ul><h3 id="global-nav">Global</h3><ul><li><a href="global.html#FormatNFTDetails">FormatNFTDetails</a></li></ul>
      </div>
    </nav>

    <div class="main">
      <div class="header"></div>
      <div class="main-content">
        
        <h1 class="page-title">
          Utils.js
        </h1>
        

        
      

<a class="button" href="Utils.html">Back</a>
<div class="source-container">
  <pre class="prettyprint source linenums"><code>const Utils = require("../Utils");

const RarityToPercentage = (rarity) => {
  if(!rarity) {
    return "";
  }

  rarity = rarity.toString();

  if(!rarity.includes("/")) {
    return rarity;
  }

  const [ numerator, denominator ] = rarity.split("/");
  let percentage = 100 * parseInt(numerator) / parseInt(denominator);

  if(percentage &lt; 1) {
    percentage = percentage.toFixed(2);
  } else {
    percentage = percentage.toFixed(1).toString().replace(".0", "");
  }

  return percentage;
};

/**
 * Format NFT or listing result into consistent format
 */
const FormatNFTDetails = function(entry) {
  const isListing = !!entry.id;

  const metadata = (isListing ? entry.nft : entry.meta) || {};
  const info = (isListing ? entry.info : entry);

  let details = {
    USDCAccepted: !!(entry.accepts || []).find(entry => entry.type === "sol"),
    USDCOnly: ((entry.accepts || []).find(entry => entry.type === "sol") || {}).preferred,
    TenantId: entry.tenant || entry.tenant_id,
    ContractAddr: info.contract_addr,
    ContractId: `ictr${Utils.AddressToHash(info.contract_addr)}`,
    ContractName: info.contract_name,
    Cap: info.cap,
    TokenIdStr: info.token_id_str,
    TokenUri: info.token_uri,
    TokenOrdinal: info.ordinal,
    TokenHold: info.hold,
    TokenHoldDate: info.hold ? new Date(parseInt(info.hold) * 1000) : undefined,
    TokenOwner: info.token_owner ? Utils.FormatAddress(info.token_owner) : "",
    VersionHash: (info.token_uri || "").split("/").find(s => (s || "").startsWith("hq__")),
  };

  if(isListing) {
    details = {
      ...details,
      // Listing specific fields
      ListingId: entry.id,
      CreatedAt: entry.created * 1000,
      UpdatedAt: entry.updated * 1000,
      CheckoutLockedUntil: entry.checkout ? entry.checkout * 1000 : undefined,
      SellerAddress: Utils.FormatAddress(entry.seller),
      Price: entry.price,
      Fee: entry.fee
    };
  }

  return {
    metadata,
    details
  };
};

exports.FormatNFTDetails = FormatNFTDetails;


const FormatNFTMetadata = function(nft) {
  nft.formatted = true;

  // Surface relevant details to top level
  nft.contractAddress = nft.details.ContractAddr;
  nft.contractId = nft.details.ContractId;
  nft.tokenId = nft.details.TokenIdStr;
  nft.name = nft.metadata.display_name;

  if(nft.details.ListingId) {
    nft.listingId = nft.details.ListingId;
  }

  // Format traits
  const FILTERED_ATTRIBUTES = ["Content Fabric Hash", "Creator", "Total Minted Supply"];
  nft.metadata.attributes = (nft.metadata.attributes || [])
    .filter(attribute => attribute &amp;&amp; !FILTERED_ATTRIBUTES.includes(attribute.trait_type))
    .map(trait => ({...trait, name: trait.trait_type, rarity_percent: RarityToPercentage(trait.rarity)}));

  // Generate embed URLs for additional media
  if(nft.metadata.additional_media) {
    nft.metadata.additional_media = nft.metadata.additional_media.map(media => {
      try {
        // Generate embed URLs for additional media
        const mediaType = (media.media_type || "").toLowerCase();

        if(mediaType === "image") {
          return {
            ...media,
            embed_url: media.media_file.url
          };
        }

        let embedUrl = new URL("https://embed.v3.contentfabric.io");
        embedUrl.searchParams.set("p", "");
        embedUrl.searchParams.set("net", rootStore.network === "demo" ? "demo" : "main");
        embedUrl.searchParams.set("ath", rootStore.authToken);

        if(mediaType === "video") {
          embedUrl.searchParams.set("vid", LinkTargetHash(media.media_link));
          embedUrl.searchParams.set("ct", "h");
          embedUrl.searchParams.set("ap", "");
        } else if(mediaType === "ebook") {
          embedUrl.searchParams.set("type", "ebook");
          embedUrl.searchParams.set("vid", media.media_file["."].container);
          embedUrl.searchParams.set("murl", btoa(media.media_file.url));
        }

        return {
          ...media,
          embed_url: embedUrl.toString()
        };
      } catch(error) {
        return media;
      }
    });
  }

  // Generate embed URLs for pack opening animations
  ["open_animation", "open_animation__mobile", "reveal_animation", "reveal_animation_mobile"].forEach(key => {
    try {
      if(nft.metadata.pack_options &amp;&amp; nft.metadata.pack_options[key]) {
        let embedUrl = new URL("https://embed.v3.contentfabric.io");
        embedUrl.searchParams.set("p", "");
        embedUrl.searchParams.set("net", rootStore.network === "demo" ? "demo" : "main");
        embedUrl.searchParams.set("ath", rootStore.authToken || rootStore.staticToken);
        embedUrl.searchParams.set("vid", LinkTargetHash(nft.metadata.pack_options[key]));
        embedUrl.searchParams.set("ap", "");

        if(!key.startsWith("reveal")) {
          embedUrl.searchParams.set("m", "");
          embedUrl.searchParams.set("lp", "");
        }

        nft.metadata.pack_options[`${key}_embed_url`] = embedUrl.toString();
      }
    // eslint-disable-next-line no-empty
    } catch(error) {}
  });

  return nft;
};

exports.FormatNFTMetadata = FormatNFTMetadata;

exports.FormatNFT = function (item) {
  return FormatNFTMetadata(FormatNFTDetails(item));
};


exports.LinkTargetHash = function(link) {
  if(!link) { return; }

  if(link["."] &amp;&amp; link["."].source) {
    return link["."].source;
  }

  if(link["/"] &amp;&amp; link["/"].startsWith("/qfab/")) {
    return link["/"].split("/").find(segment => segment.startsWith("hq__"));
  }

  if(link["."] &amp;&amp; link["."].container) {
    return link["."].container;
  }
};

// https://stackoverflow.com/questions/4068373/center-a-popup-window-on-screen
const Popup = ({url, title, w, h}) => {
  // Fixes dual-screen position
  const dualScreenLeft = window.screenLeft || window.screenX;
  const dualScreenTop = window.screenTop || window.screenY;

  const width = window.innerWidth || document.documentElement.clientWidth || screen.width;
  const height = window.innerHeight || document.documentElement.clientHeight || screen.height;

  const systemZoom = width / window.screen.availWidth;
  const left = (width - w) / 2 / systemZoom + dualScreenLeft;
  const top = (height - h) / 2 / systemZoom + dualScreenTop;
  const newWindow = window.open(url, title,
    `
      width=${w / systemZoom},
      height=${h / systemZoom},
      top=${top},
      left=${left}
    `
  );

  if(window.focus) newWindow.focus();

  return newWindow;
};

exports.ActionPopup = async ({mode="tab", url, onMessage, onCancel}) => {
  await new Promise(resolve => {
    const newWindow = mode === "popup" ?
      Popup({url, title: "Eluvio Media Wallet", w: 500, h: 850}) :
      window.open(url);

    const closeCheck = setInterval(async () => {
      if(newWindow.closed) {
        clearInterval(closeCheck);

        if(onCancel) {
          await onCancel();
        }

        resolve();
      }
    }, 500);

    window.addEventListener("message", async event => {
      await onMessage(
        event,
        () => {
          clearInterval(closeCheck);
          newWindow.close();
          resolve();
        }
      );
    });
  });
};
</code></pre>
</div>

    



        <footer class="footer">
          Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.10</a>
        </footer>
      </div>
    </div>
  </div>

  <script>
    // Format and add line numbers to code
    prettyPrint();
  </script>

  <script type="text/javascript" src="scripts/utils.js"></script>

  </body>
</html>
